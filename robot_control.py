import rclpy
from rclpy.node import Node
from geometry_msgs.msg import Twist
from nav_msgs.msg import Odometry
from visualization_msgs.msg import Marker, MarkerArray
import numpy as np
import math

class PIDController:
    def __init__(self, kp, ki, kd, dt=0.1, integral_limit=10.0, derivative_limit=10.0):
        self.kp = kp
        self.ki = ki
        self.kd = kd
        self.dt = dt
        self.integral = 0
        self.prev_error = 0
        self.integral_limit = integral_limit
        self.derivative_limit = derivative_limit

    def update(self, error):
        self.integral += error * self.dt
        self.integral = np.clip(self.integral, -self.integral_limit, self.integral_limit)
        derivative = (error - self.prev_error) / self.dt
        derivative = np.clip(derivative, -self.derivative_limit, self.derivative_limit)
        output = self.kp * error + self.ki * self.integral + self.kd * derivative
        self.prev_error = error
        if np.isnan(output) or np.isinf(output):
            output = 0
        return output

class TurtleBotController(Node):
    def __init__(self):
        super().__init__('turtlebot_controller')
        
        # Parameters
        self.path = [(0, 0), (1, 1), (1, 2), (2, 3), (3, 4), (3, 5), (3, 6), (3, 7), (3, 8), (3, 9), (3, 10), (3, 11), (3, 12), (3, 13), (3, 14), (3, 15), (3, 16), (3, 17), (3, 18), (3, 19), (3, 20), (3, 21), (3, 22), (3, 23), (3, 24), (3, 25), (3, 26), (3, 27), (3, 28), (3, 29), (3, 30), (4, 31), (5, 32), (6, 33), (7, 34), (8, 35), (9, 36), (10, 37), (11, 38), (12, 39), (13, 40), (14, 41), (15, 42), (16, 43), (17, 44), (18, 45), (19, 46), (20, 47), (21, 48), (22, 49), (23, 50), (24, 51), (24, 52), (24, 53), (24, 54), (24, 55), (25, 56), (25, 57), (25, 58), (25, 59), (25, 60), (25, 61), (25, 62), (25, 63), (25, 64), (25, 65), (25, 66), (25, 67), (25, 68), (25, 69), (25, 70), (25, 71), (25, 72), (25, 73), (25, 74), (25, 75), (25, 76), (25, 77), (25, 78), (26, 79), (26, 80), (26, 81), (26, 82), (26, 83), (26, 84), (27, 85), (27, 86), (27, 87), (27, 88), (27, 89), (28, 90), (28, 91), (28, 92), (28, 93), (28, 94), (28, 95), (29, 96), (29, 97), (29, 98), (29, 99), (29, 100), (29, 101), (29, 102), (29, 103), (29, 104), (29, 105), (29, 106), (29, 107), (29, 108), (29, 109), (29, 110), (29, 111), (29, 112), (29, 113), (29, 114), (29, 115), (29, 116), (29, 117), (29, 118), (29, 119), (29, 120), (29, 121), (29, 122), (29, 123), (29, 124), (29, 125), (29, 126), (29, 127), (29, 128), (29, 129), (29, 130), (29, 131), (29, 132), (29, 133), (29, 134), (29, 135), (29, 136), (29, 137), (29, 138), (29, 139), (29, 140), (29, 141), (29, 142), (29, 143), (29, 144), (29, 145), (29, 146), (29, 147), (29, 148), (29, 149), (29, 150), (29, 151), (29, 152), (29, 153), (29, 154), (29, 155), (29, 156), (29, 157), (29, 158), (29, 159), (29, 160), (29, 161), (29, 162), (29, 163), (29, 164), (29, 165), (29, 166), (29, 167), (29, 168), (29, 169), (29, 170), (29, 171), (29, 172), (29, 173), (29, 174), (29, 175), (29, 176), (29, 177), (29, 178), (29, 179), (29, 180), (29, 181), (29, 182), (29, 183), (29, 184), (29, 185), (29, 186), (29, 187), (29, 188), (29, 189), (29, 190), (29, 191), (29, 192), (29, 193), (29, 194), (29, 195), (29, 196), (29, 197), (29, 198), (29, 199), (29, 200), (29, 201), (29, 202), (29, 203), (29, 204), (29, 205), (29, 206), (29, 207), (29, 208), (29, 209), (29, 210), (29, 211), (29, 212), (29, 213), (29, 214), (29, 215), (29, 216), (29, 217), (29, 218), (29, 219), (29, 220), (29, 221), (29, 222), (29, 223), (29, 224), (29, 225), (29, 226), (29, 227), (29, 228), (29, 229), (29, 230), (29, 231), (29, 232), (29, 233), (29, 234), (29, 235), (29, 236), (29, 237), (29, 238), (29, 239), (29, 240), (29, 241), (29, 242), (29, 243), (29, 244), (29, 245), (29, 246), (29, 247), (29, 248), (29, 249), (29, 250), (29, 251), (29, 252), (29, 253), (29, 254), (29, 255), (29, 256), (29, 257), (29, 258), (29, 259), (29, 260), (29, 261), (29, 262), (29, 263), (29, 264), (29, 265), (29, 266), (29, 267), (29, 268), (29, 269), (29, 270), (29, 271), (29, 272), (29, 273), (29, 274), (29, 275), (29, 276), (29, 277), (29, 278), (29, 279), (29, 280), (29, 281), (29, 282), (29, 283), (29, 284), (29, 285), (29, 286), (29, 287), (29, 288), (29, 289), (29, 290), (29, 291), (29, 292), (29, 293), (29, 294), (29, 295), (29, 296), (29, 297), (29, 298), (29, 299), (29, 300), (29, 301), (29, 302), (29, 303), (29, 304), (29, 305), (29, 306), (29, 307), (29, 308), (29, 309), (29, 310), (29, 311), (29, 312), (29, 313), (29, 314), (29, 315), (29, 316), (29, 317), (29, 318), (29, 319), (29, 320), (29, 321), (30, 322), (30, 323), (30, 324), (30, 325), (30, 326), (30, 327), (30, 328), (30, 329), (30, 330), (30, 331), (31, 332), (31, 333), (31, 334), (31, 335), (31, 336), (31, 337), (31, 338), (31, 339), (31, 340), (31, 341), (32, 342), (32, 343), (32, 344), (32, 345), (32, 346), (32, 347), (32, 348), (32, 349), (32, 350), (32, 351), (32, 352), (32, 353), (32, 354), (32, 355), (32, 356), (32, 357), (32, 358), (32, 359), (32, 360), (32, 361), (32, 362), (32, 363), (32, 364), (32, 365), (32, 366), (32, 367), (32, 368), (32, 369), (32, 370), (32, 371), (32, 372), (32, 373), (32, 374), (32, 375), (32, 376), (32, 377), (32, 378), (32, 379), (32, 380), (32, 381), (32, 382), (32, 383), (32, 384), (32, 385), (32, 386), (32, 387), (32, 388), (32, 389), (32, 390), (32, 391), (32, 392), (32, 393), (32, 394), (32, 395), (32, 396), (32, 397), (32, 398), (32, 399), (32, 400), (32, 401), (32, 402), (32, 403), (32, 404), (32, 405), (32, 406), (32, 407), (32, 408), (32, 409), (32, 410), (32, 411), (32, 412), (32, 413), (32, 414), (33, 415), (33, 416), (33, 417), (33, 418), (33, 419), (33, 420), (33, 421), (33, 422), (33, 423), (33, 424), (33, 425), (33, 426), (33, 427), (34, 428), (34, 429), (34, 430), (34, 431), (34, 432), (34, 433), (35, 434), (35, 435), (35, 436), (35, 437), (35, 438), (35, 439), (36, 440), (36, 441), (36, 442), (36, 443), (36, 444), (36, 445), (36, 446), (37, 447), (37, 448), (37, 449), (37, 450), (37, 451), (37, 452), (37, 453), (38, 454), (38, 455), (38, 456), (38, 457), (38, 458), (38, 459), (38, 460), (39, 461), (39, 462), (39, 463), (39, 464), (40, 465), (40, 466), (40, 467), (40, 468), (40, 469), (41, 470), (41, 471), (41, 472), (41, 473), (41, 474), (42, 475), (42, 476), (42, 477), (43, 478), (43, 479), (43, 480), (43, 481), (44, 482), (44, 483), (44, 484), (45, 485), (46, 486), (46, 487), (47, 488), (48, 489), (49, 489), (50, 489), (51, 489), (52, 489), (53, 489), (54, 489), (55, 489), (56, 489), (57, 489), (58, 489), (59, 489), (60, 488), (61, 487), (62, 486), (63, 485), (64, 484), (65, 483), (66, 482), (67, 481), (68, 480), (69, 479), (70, 478), (71, 477), (72, 476), (73, 475), (74, 474), (75, 473), (76, 472), (77, 471), (78, 470), (79, 469), (80, 468), (81, 467), (82, 466), (83, 465), (84, 464), (85, 463), (86, 462), (87, 461), (88, 460), (89, 459), (90, 458), (91, 457), (92, 456), (92, 455), (92, 454), (92, 453), (92, 452), (92, 451), (92, 450), (92, 449), (92, 448), (92, 447), (92, 446), (92, 445), (92, 444), (92, 443), (92, 442), (92, 441), (92, 440), (92, 439), (92, 438), (92, 437), (92, 436), (92, 435), (92, 434), (92, 433), (92, 432), (92, 431), (92, 430), (92, 429), (92, 428), (92, 427), (92, 426), (92, 425), (92, 424), (92, 423), (92, 422), (92, 421), (92, 420), (92, 419), (92, 418), (92, 417), (92, 416), (92, 415), (92, 414), (92, 413), (92, 412), (92, 411), (92, 410), (92, 409), (92, 408), (92, 407), (92, 406), (92, 405), (92, 404), (92, 403), (92, 402), (92, 401), (92, 400), (92, 399), (92, 398), (92, 397), (92, 396), (92, 395), (92, 394), (92, 393), (92, 392), (92, 391), (92, 390), (92, 389), (92, 388), (92, 387), (92, 386), (92, 385), (92, 384), (92, 383), (91, 382), (90, 381), (89, 380), (88, 379), (87, 378), (86, 377), (85, 376), (84, 375), (83, 374), (82, 373), (81, 372), (80, 371), (80, 370), (79, 369), (78, 368), (78, 367), (77, 366), (76, 365), (76, 364), (75, 363), (74, 362), (74, 361), (74, 360), (73, 359), (73, 358), (73, 357), (73, 356), (72, 355), (72, 354), (72, 353), (72, 352), (72, 351), (72, 350), (72, 349), (72, 348), (72, 347), (72, 346), (72, 345), (72, 344), (72, 343), (72, 342), (72, 341), (72, 340), (72, 339), (72, 338), (72, 337), (72, 336), (72, 335), (72, 334), (72, 333), (73, 332), (74, 332), (75, 332), (76, 332), (77, 332), (78, 332), (79, 332), (80, 332), (81, 332), (82, 333), (83, 333), (84, 333), (85, 334), (86, 334), (87, 335), (88, 336), (89, 336), (90, 337), (91, 338), (92, 338), (93, 339), (94, 340), (95, 340), (96, 341), (97, 342), (98, 343), (99, 344), (100, 345), (101, 346), (102, 347), (103, 348), (104, 349), (105, 350), (106, 351), (107, 352), (108, 353), (109, 354), (110, 355), (111, 356), (112, 357), (113, 358), (114, 359), (115, 360), (116, 361), (117, 362), (118, 363), (119, 364), (120, 365), (121, 366), (122, 367), (123, 368), (124, 369), (125, 370), (126, 371), (127, 372), (128, 373), (129, 374), (130, 375), (131, 376), (132, 377), (133, 378), (134, 379), (135, 380), (136, 381), (137, 382), (138, 383), (139, 384), (140, 385), (141, 386), (142, 387), (142, 388), (142, 389), (143, 390), (143, 391), (144, 392), (145, 393), (145, 394), (146, 395), (146, 396), (147, 397), (147, 398), (148, 399), (149, 400), (150, 401), (151, 402), (152, 403), (153, 404), (154, 405), (155, 405), (156, 405), (157, 405), (158, 405), (159, 405), (160, 405), (161, 405), (162, 405), (163, 405), (164, 405), (165, 405), (166, 405), (167, 405), (168, 405), (169, 405), (170, 405), (171, 405), (172, 405), (173, 405), (174, 405), (175, 405), (176, 405), (177, 405), (178, 405), (179, 405), (180, 405), (181, 405), (182, 405), (183, 405), (184, 406), (185, 407), (186, 408), (187, 409), (188, 410), (189, 411), (190, 412), (191, 413), (192, 414), (193, 415), (194, 416), (195, 417), (196, 418), (196, 419), (196, 420), (196, 421), (196, 422), (196, 423), (196, 424), (196, 425), (196, 426), (196, 427), (196, 428), (196, 429), (196, 430), (196, 431), (196, 432), (196, 433), (196, 434), (196, 435), (196, 436), (196, 437), (196, 438), (196, 439), (196, 440), (196, 441), (196, 442), (196, 443), (196, 444), (196, 445), (196, 446), (196, 447), (196, 448), (196, 449), (196, 450), (196, 451), (196, 452), (196, 453), (196, 454), (196, 455), (196, 456), (196, 457), (196, 458), (196, 459), (196, 460), (196, 461), (195, 462), (194, 463), (193, 464), (192, 465), (191, 466), (190, 467), (189, 468), (188, 469), (187, 470), (186, 471), (185, 472), (184, 473), (183, 474), (182, 475), (181, 476), (180, 477), (179, 478), (178, 479), (177, 480), (176, 481), (175, 482), (174, 483), (173, 484), (172, 485), (171, 486), (170, 487), (169, 488), (168, 489), (167, 490), (166, 491), (165, 492), (164, 493), (163, 494), (162, 495), (161, 496), (160, 497), (159, 498), (158, 498), (157, 498), (156, 498), (155, 498), (154, 498), (153, 498), (152, 498), (151, 498), (150, 498), (149, 498), (148, 498), (147, 498), (146, 498), (145, 498), (144, 498), (143, 498), (142, 498), (141, 498), (140, 498), (139, 498), (138, 498), (137, 498), (136, 498), (135, 498), (134, 498), (133, 498), (132, 498), (131, 498), (130, 498), (129, 498), (128, 498), (127, 498), (126, 498), (125, 498), (124, 498), (123, 498), (122, 498), (121, 498), (120, 498), (119, 498), (118, 498), (117, 498), (116, 498), (115, 498), (114, 498), (113, 499), (112, 499), (111, 499), (110, 500), (109, 500), (108, 500), (107, 501), (106, 502), (105, 503), (104, 504), (103, 505), (102, 506), (101, 507), (100, 508), (99, 509), (98, 510), (97, 511), (96, 512), (95, 513), (94, 514), (93, 515), (92, 516), (91, 517), (90, 518), (89, 519), (88, 520), (87, 521), (86, 522), (85, 523), (84, 524), (83, 525), (82, 526), (81, 527), (80, 528), (79, 529), (78, 530), (77, 531), (76, 532), (75, 533), (74, 534), (73, 535), (72, 536), (71, 537), (70, 538), (69, 539), (68, 540), (67, 541), (66, 542), (65, 543), (64, 544), (63, 545), (62, 546), (61, 547), (60, 548), (59, 549), (58, 550), (57, 551), (56, 552), (55, 553), (54, 554), (53, 555), (52, 556), (51, 557), (50, 558), (49, 559), (48, 560), (47, 561), (47, 562), (46, 563), (46, 564), (46, 565), (46, 566), (46, 567), (46, 568), (46, 569), (46, 570), (47, 571), (47, 572), (48, 573), (49, 573), (50, 573), (51, 573), (52, 573), (53, 573), (54, 573), (55, 573), (56, 573), (57, 573), (58, 573), (59, 573), (60, 573), (61, 573), (62, 573), (63, 573), (64, 573), (65, 573), (66, 573), (67, 573), (68, 573), (69, 573), (70, 573), (71, 573), (72, 573), (73, 573), (74, 573), (75, 573), (76, 573), (77, 573), (78, 573), (79, 573), (80, 573), (81, 573), (82, 573), (83, 573), (84, 573), (85, 573), (86, 573), (87, 573), (88, 573), (89, 573), (90, 573), (91, 573), (92, 573), (93, 573), (94, 573), (95, 573), (96, 573), (97, 573), (98, 573), (99, 573), (100, 573), (101, 573), (102, 573), (103, 573), (104, 573), (105, 573), (106, 573), (107, 573), (108, 573), (109, 573), (110, 573), (111, 573), (112, 573), (113, 573), (114, 574), (115, 575), (116, 576), (117, 577), (118, 578), (119, 579), (120, 580), (121, 581), (122, 581), (123, 581), (124, 581), (125, 581), (126, 581), (127, 581), (128, 581), (129, 581), (130, 581), (131, 581), (132, 581), (133, 581), (134, 581), (135, 581), (136, 581), (137, 581), (138, 581), (139, 581), (140, 581), (141, 581), (142, 581), (143, 581), (144, 581), (145, 581), (146, 581), (147, 581), (148, 581), (149, 581), (150, 581), (151, 581), (152, 581), (153, 581), (154, 581), (155, 581), (156, 581), (157, 581), (158, 581), (159, 581), (160, 581), (161, 581), (162, 581), (163, 581), (164, 581), (165, 581), (166, 581), (167, 581), (168, 582), (169, 582), (170, 582), (171, 582), (172, 582), (173, 582), (174, 582), (175, 582), (176, 582), (177, 582), (178, 582), (179, 582), (180, 582), (181, 582), (182, 582), (183, 582), (184, 582), (185, 582), (186, 582), (187, 582), (188, 582), (189, 582), (190, 582), (191, 582), (192, 582), (193, 582), (194, 582), (195, 582), (196, 582), (197, 582), (198, 582), (199, 582), (200, 582), (201, 582), (202, 582), (203, 582), (204, 582), (205, 583), (206, 583), (207, 583), (208, 583), (209, 583), (210, 583), (211, 583), (212, 583), (213, 583), (214, 583), (215, 583), (216, 583), (217, 583), (218, 583), (219, 583), (220, 583), (221, 583), (222, 583), (223, 583), (224, 583), (225, 583), (226, 583), (227, 583), (228, 583), (229, 583), (230, 583), (231, 583), (232, 583), (233, 583), (234, 583), (235, 583), (236, 583), (237, 583), (238, 583), (239, 583), (240, 583), (241, 583), (242, 583), (243, 583), (244, 583), (245, 583), (246, 583), (247, 583), (248, 583), (249, 583), (250, 583), (251, 583), (252, 583), (253, 583), (254, 583), (255, 583), (256, 583), (257, 583), (258, 583), (259, 583), (260, 583), (261, 583), (262, 583), (263, 583), (264, 583), (265, 583), (266, 583), (267, 583), (268, 583), (269, 583), (270, 583), (271, 583), (272, 583), (273, 583), (274, 583), (275, 583), (276, 583), (277, 583), (278, 583), (279, 583), (280, 583), (281, 583), (282, 583), (283, 583), (284, 583), (285, 583), (286, 583), (287, 583), (288, 583), (289, 583), (290, 583), (291, 583), (292, 583), (293, 583), (294, 583), (295, 583), (296, 583), (297, 583), (298, 583), (299, 583), (300, 583), (301, 584), (302, 584), (303, 584), (304, 585), (305, 585), (306, 586), (307, 586), (308, 587), (309, 587), (310, 588), (311, 588), (312, 589), (313, 589), (314, 589), (315, 590), (316, 590), (317, 591), (318, 591), (319, 592), (320, 592), (321, 593), (322, 593), (323, 594), (324, 594), (325, 594), (326, 595), (327, 595), (328, 596), (329, 596), (330, 597), (331, 597), (332, 598), (333, 598), (334, 598), (335, 599)]

        self.current_index = 0
        self.position = np.array([0.0, 0.0], dtype=np.float32)
        self.orientation = 0.0
        self.reached_goal = False
        self.dt = 0.1

        # Initialize PID Controllers
        self.linear_pid = PIDController(kp=1.0, ki=0.02, kd=0.2, dt=self.dt)
        self.angular_pid = PIDController(kp=2.0, ki=0.15, kd=0.2, dt=self.dt)

        # Publishers and Subscribers
        self.cmd_vel_pub = self.create_publisher(Twist, '/cmd_vel', 10)
        self.odom_sub = self.create_subscription(Odometry, '/odom', self.odom_callback, 10)
        
        # Marker publisher
        self.marker_pub = self.create_publisher(MarkerArray, '/waypoints_markers', 10)
        
        # Timer for control loop and marker publishing
        self.timer = self.create_timer(self.dt, self.control_loop)
        self.marker_timer = self.create_timer(1.0, self.publish_markers)

    def odom_callback(self, msg):
        self.position[0] = msg.pose.pose.position.x
        self.position[1] = msg.pose.pose.position.y
        q = msg.pose.pose.orientation
        _, _, yaw = self.quaternion_to_euler(q.x, q.y, q.z, q.w)
        self.orientation = yaw

    def quaternion_to_euler(self, x, y, z, w):
        t3 = +2.0 * (w * z + x * y)
        t4 = +1.0 - 2.0 * (y * y + z * z)
        return (0.0, 0.0, math.atan2(t3, t4))

    def control_loop(self):
        if self.current_index >= len(self.path) or self.reached_goal:
            self.cmd_vel_pub.publish(Twist())
            self.reached_goal = True
            return

        target = np.array(self.path[self.current_index], dtype=np.float32)
        error_vector = target - self.position
        distance_error = np.linalg.norm(error_vector)

        if distance_error < 0.1:
            self.current_index += 1
            if self.current_index >= len(self.path):
                self.reached_goal = True
                self.cmd_vel_pub.publish(Twist())
            return

        target_angle = np.arctan2(error_vector[1], error_vector[0])
        angular_error = target_angle - self.orientation
        angular_error = (angular_error + np.pi) % (2 * np.pi) - np.pi
        
        vx = self.linear_pid.update(distance_error)
        omega = self.angular_pid.update(angular_error)

        cmd_msg = Twist()
        cmd_msg.linear.x = np.clip(vx, 0.0, 0.5)
        cmd_msg.angular.z = np.clip(omega, -1.5, 1.5)
        self.cmd_vel_pub.publish(cmd_msg)

    def publish_markers(self):
        marker_array = MarkerArray()

        # Markers for target path
        for i, (x, y) in enumerate(self.path):
            marker = Marker()
            marker.header.frame_id = "odom"
            marker.type = Marker.SPHERE
            marker.action = Marker.ADD
            marker.pose.position.x = float(x)
            marker.pose.position.y = float(y)
            marker.pose.position.z = 0.0
            marker.scale.x = 0.1
            marker.scale.y = 0.1
            marker.scale.z = 0.1
            marker.color.a = 1.0
            marker.color.r = 1.0
            marker.color.g = 0.0
            marker.color.b = 0.0
            marker.id = i
            marker_array.markers.append(marker)

        # Marker for followed path (updated robot position)
        followed_marker = Marker()
        followed_marker.header.frame_id = "odom"
        followed_marker.type = Marker.SPHERE
        followed_marker.action = Marker.ADD
        followed_marker.pose.position.x = float(self.position[0])
        followed_marker.pose.position.y = float(self.position[1])
        followed_marker.pose.position.z = 0.0
        followed_marker.scale.x = 0.15
        followed_marker.scale.y = 0.15
        followed_marker.scale.z = 0.15
        followed_marker.color.a = 1.0
        followed_marker.color.r = 0.0
        followed_marker.color.g = 1.0
        followed_marker.color.b = 0.0
        followed_marker.id = len(self.path)  # Unique ID for this marker
        marker_array.markers.append(followed_marker)

        self.marker_pub.publish(marker_array)

def main(args=None):
    rclpy.init(args=args)
    turtlebot_controller = TurtleBotController()
    rclpy.spin(turtlebot_controller)
    turtlebot_controller.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
